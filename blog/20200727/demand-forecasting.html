<!DOCTYPE html>
<html lang="en"><head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-303PJS70LR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-303PJS70LR');
</script><meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Profit-Driven Demand Forecasting | Nikita Kozodoi</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Profit-Driven Demand Forecasting" />
<meta name="author" content="Nikita Kozodoi" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Data Mining Cup 2020 solution with graident boosted trees" />
<meta property="og:description" content="Data Mining Cup 2020 solution with graident boosted trees" />
<link rel="canonical" href="https://kozodoi.me/blog/20200727/demand-forecasting" />
<meta property="og:url" content="https://kozodoi.me/blog/20200727/demand-forecasting" />
<meta property="og:site_name" content="Nikita Kozodoi" />
<meta property="og:image" content="https://kozodoi.me/images/posts/demand.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-27T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Profit-Driven Demand Forecasting","dateModified":"2020-07-27T00:00:00-05:00","datePublished":"2020-07-27T00:00:00-05:00","description":"Data Mining Cup 2020 solution with graident boosted trees","author":{"@type":"Person","name":"Nikita Kozodoi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kozodoi.me/blog/20200727/demand-forecasting"},"image":"https://kozodoi.me/images/posts/demand.png","@type":"BlogPosting","url":"https://kozodoi.me/blog/20200727/demand-forecasting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://kozodoi.me/feed.xml" title="Nikita Kozodoi" /><link rel="apple-touch-icon" sizes="76x76" href="https://kozodoi.me/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kozodoi.me/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://kozodoi.me/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://kozodoi.me/site.webmanifest">
<link rel="mask-icon" href="https://kozodoi.me/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="https://kozodoi.me/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Profit-Driven Demand Forecasting | Nikita Kozodoi</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Profit-Driven Demand Forecasting" />
<meta name="author" content="Nikita Kozodoi" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Data Mining Cup 2020 solution with graident boosted trees" />
<meta property="og:description" content="Data Mining Cup 2020 solution with graident boosted trees" />
<link rel="canonical" href="https://kozodoi.me/blog/20200727/demand-forecasting" />
<meta property="og:url" content="https://kozodoi.me/blog/20200727/demand-forecasting" />
<meta property="og:site_name" content="Nikita Kozodoi" />
<meta property="og:image" content="https://kozodoi.me/images/posts/demand.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-27T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Profit-Driven Demand Forecasting","dateModified":"2020-07-27T00:00:00-05:00","datePublished":"2020-07-27T00:00:00-05:00","description":"Data Mining Cup 2020 solution with graident boosted trees","author":{"@type":"Person","name":"Nikita Kozodoi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kozodoi.me/blog/20200727/demand-forecasting"},"image":"https://kozodoi.me/images/posts/demand.png","@type":"BlogPosting","url":"https://kozodoi.me/blog/20200727/demand-forecasting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://kozodoi.me/feed.xml" title="Nikita Kozodoi" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Nikita Kozodoi</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/portfolio/">Portfolio</a><a class="page-link" href="/talks/">Talks</a><a class="page-link" href="/papers/">Papers</a><a class="page-link" href="/kaggle/">Kaggle</a><a class="page-link" href="/search/">Search</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Profit-Driven Demand Forecasting</h1><p class="page-description">Data Mining Cup 2020 solution with graident boosted trees</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-27T00:00:00-05:00" itemprop="datePublished">
        Jul 27, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Nikita Kozodoi</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      31 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i>
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#time series">time series</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#demand forecasting">demand forecasting</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#competitions">competitions</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">
  <label class="switch">
    <input type="checkbox" href="/blog/20200727/demand-forecasting" id="theme-toggle" checked onclick="modeSwitcher();">
      <span class="slider round"></span>
  </label>
</div>

          <div class="px-2">

    <a href="https://github.com/kozodoi/website/tree/master/_notebooks/2020-07-27-demand-forecasting.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View on GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/kozodoi/website/blob/master/_notebooks/2020-07-27-demand-forecasting.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open in Colab"/>
    </a>
</div>
        </div>
      
      <img src="/images/covers/demand.png" style="width:100%"/>
    <script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=607a88d1f94d5c00182f2b41&product=inline-share-buttons" async="async"></script>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#1.-Overview">1. Overview </a></li>
<li class="toc-entry toc-h1"><a href="#2.-Data-preparation">2. Data preparation </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Data-overview">Data overview </a></li>
<li class="toc-entry toc-h2"><a href="#Preprocessing">Preprocessing </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#3.-Aggregation-and-feature-engineering">3. Aggregation and feature engineering </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Data-aggregation">Data aggregation </a></li>
<li class="toc-entry toc-h2"><a href="#Adding-missing-item-day-combinations">Adding missing item-day combinations </a></li>
<li class="toc-entry toc-h2"><a href="#Labeling-promotions">Labeling promotions </a></li>
<li class="toc-entry toc-h2"><a href="#Feature-engineering">Feature engineering </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#4.-Modeling">4. Modeling </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Custom-loss-functions">Custom loss functions </a></li>
<li class="toc-entry toc-h2"><a href="#Modeling-pipeline">Modeling pipeline </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#5.-Hyper-parameter-tuning">5. Hyper-parameter tuning </a></li>
<li class="toc-entry toc-h1"><a href="#6.-Closing-words">6. Closing words </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-07-27-demand-forecasting.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Last update: 21.03.2021. All opinions are my own.</em></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="1.-Overview">
<a class="anchor" href="#1.-Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Overview<a class="anchor-link" href="#1.-Overview"> </a>
</h1>
<p>Demand forecasting is an important task that helps to optimize inventory planning. Optimized stocks reduce retailer's costs and increase customer satisfaction due to faster delivery time.</p>
<p>The 2020 edition of the <a href="https://www.data-mining-cup.com">Data Mining Cup</a> was devoted to profit-driven demand prediction for a set of items using past purchase data. Together with <a href="https://www.linkedin.com/in/elizaveta-zinovyeva-4155a184/">Elizaveta Zinovyeva</a>, we represented the <a href="https://www.hu-berlin.de/en?set_language=en">Humboldt University of Berlin</a> and finished in the top-15 of the leaderboard.</p>
<p>This blog post provides a detailed walkthrough covering the crucial steps of our solution:</p>
<ul>
<li>data preparation and feature engineering</li>
<li>aggregation of transactional data into the daily format</li>
<li>implementation of custom profit loss functions</li>
<li>two-stage demand forecasting with LightGBM</li>
<li>hyper-parameter tuning with <code>hyperopt</code>
</li>
</ul>
<p>Feel free to jump directly to the sections interesting to you! The code with our solution is available <a href="https://github.com/kozodoi/DMC_2020">on Github</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="2.-Data-preparation">
<a class="anchor" href="#2.-Data-preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Data preparation<a class="anchor-link" href="#2.-Data-preparation"> </a>
</h1>
<h2 id="Data-overview">
<a class="anchor" href="#Data-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data overview<a class="anchor-link" href="#Data-overview"> </a>
</h2>
<p>The competition data includes three files:</p>
<ul>
<li>
<code>items.csv</code>: item-specific characteristics such as brand, manufacturer, etc</li>
<li>
<code>orders.csv</code>: purchase transactions over the 6-month period</li>
<li>
<code>infos.csv</code>: prices and promotions in the unlabeled test set</li>
</ul>
<p>Let's have a look at the data:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># data import</span>
<span class="n">infos</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/raw/infos.csv'</span><span class="p">,</span>  <span class="n">sep</span> <span class="o">=</span> <span class="s1">'|'</span><span class="p">)</span>
<span class="n">items</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/raw/items.csv'</span><span class="p">,</span>  <span class="n">sep</span> <span class="o">=</span> <span class="s1">'|'</span><span class="p">)</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/raw/orders.csv'</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">'|'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">infos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(10463, 3)
(10463, 8)
(2181955, 5)
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">infos</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemID</th>
      <th>simulationPrice</th>
      <th>promotion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>3.43</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2</td>
      <td>9.15</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3</td>
      <td>14.04</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemID</th>
      <th>brand</th>
      <th>manufacturer</th>
      <th>customerRating</th>
      <th>category1</th>
      <th>category2</th>
      <th>category3</th>
      <th>recommendedRetailPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>4.38</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>8.84</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>3.00</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>16.92</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>5.00</td>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>15.89</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">orders</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>transactID</th>
      <th>itemID</th>
      <th>order</th>
      <th>salesPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2018-01-01 00:01:56</td>
      <td>2278968</td>
      <td>450</td>
      <td>1</td>
      <td>17.42</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2018-01-01 00:01:56</td>
      <td>2278968</td>
      <td>83</td>
      <td>1</td>
      <td>5.19</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2018-01-01 00:07:11</td>
      <td>2255797</td>
      <td>7851</td>
      <td>2</td>
      <td>20.47</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For each of the 10,463 items, we need to predict the total number of orders in the 14-day period following the last day in <code>orders</code>.</p>
<h2 id="Preprocessing">
<a class="anchor" href="#Preprocessing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preprocessing<a class="anchor-link" href="#Preprocessing"> </a>
</h2>
<p>Let's prepare the data! First, we merge item-level data in <code>items</code> and <code>infos</code>:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">infos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'itemID'</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">del</span> <span class="n">infos</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(10463, 3)
(10463, 8)
(10463, 10)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we check and convert feature types to the appropriate format:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># items</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'brand'</span><span class="p">,</span> <span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'category1'</span><span class="p">,</span> <span class="s1">'category2'</span><span class="p">,</span> <span class="s1">'category3'</span><span class="p">]:</span>
    <span class="n">items</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'object'</span><span class="p">)</span> 
    
<span class="c1"># orders</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'transactID'</span><span class="p">,</span> <span class="s1">'itemID'</span><span class="p">]:</span>
    <span class="n">orders</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'object'</span><span class="p">)</span> 
    
<span class="c1"># dates</span>
<span class="n">orders</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'str'</span><span class="p">),</span> <span class="n">infer_datetime_format</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--------------------------------------------------
itemID                      int64
simulationPrice           float64
promotion                  object
brand                       int64
manufacturer                int64
customerRating            float64
category1                   int64
category2                   int64
category3                   int64
recommendedRetailPrice    float64
dtype: object
--------------------------------------------------
time           object
transactID      int64
itemID          int64
order           int64
salesPrice    float64
dtype: object
--------------------------------------------------
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we unfold the <code>promotion</code> feature containing a sequence of coma-separated dates. We use <code>split_nested_features()</code> from <code>dptools</code> to split a string column into separate features.</p>
<p><code>dptools</code> is a package developed by me to simplify common data preprocessing and feature engineering tasks. Below, you will see more examples on using <code>dptools</code> for other applications. You can read more about the package <a href="https://github.com/kozodoi/dptools">here</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># import packages</span>
<span class="o">!</span>pip install dptools
<span class="kn">from</span> <span class="nn">dptools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># split promotion feature</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">split_nested_features</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">split_vars</span> <span class="o">=</span> <span class="s1">'promotion'</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">','</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># convert dates</span>
<span class="n">promotion_vars</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span> <span class="o">=</span> <span class="s1">'promotion_'</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">promotion_vars</span><span class="p">:</span>
    <span class="n">items</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">infer_datetime_format</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Added 3 split-based features.
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemID</th>
      <th>simulationPrice</th>
      <th>brand</th>
      <th>manufacturer</th>
      <th>customerRating</th>
      <th>category1</th>
      <th>category2</th>
      <th>category3</th>
      <th>recommendedRetailPrice</th>
      <th>promotion_0</th>
      <th>promotion_1</th>
      <th>promotion_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>3.43</td>
      <td>NaN</td>
      <td>1</td>
      <td>4.38</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>8.84</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2</td>
      <td>9.15</td>
      <td>NaN</td>
      <td>2</td>
      <td>3.00</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>16.92</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3</td>
      <td>14.04</td>
      <td>NaN</td>
      <td>3</td>
      <td>5.00</td>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>15.89</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now export the data as csv. I use <code>save_csv_version()</code> to automatically add a version number to the file name to prevent overwriting the data after making changes.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">save_csv_version</span><span class="p">(</span><span class="s1">'../data/prepared/orders.csv'</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">'gzip'</span><span class="p">)</span>
<span class="n">save_csv_version</span><span class="p">(</span><span class="s1">'../data/prepared/items.csv'</span><span class="p">,</span>  <span class="n">items</span><span class="p">,</span>  <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">'gzip'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Saved as ../data/prepared/orders_v2.csv
Saved as ../data/prepared/items_v2.csv
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="3.-Aggregation-and-feature-engineering">
<a class="anchor" href="#3.-Aggregation-and-feature-engineering" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Aggregation and feature engineering<a class="anchor-link" href="#3.-Aggregation-and-feature-engineering"> </a>
</h1>
<h2 id="Data-aggregation">
<a class="anchor" href="#Data-aggregation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data aggregation<a class="anchor-link" href="#Data-aggregation"> </a>
</h2>
<p>Let's work with <code>orders</code>, which provides a list of transactions with timestamps.</p>
<p>We need to aggregate this data for future modeling. Since the task is a 14-day demand forecasting, a simple way would be to aggregate transactions on a two-week basis. However, this could lead to losing some more granular information. We aggregate transactions by day:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>
<span class="n">orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
<span class="n">orders_price</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'day_of_year'</span><span class="p">])[</span><span class="s1">'salesPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'day_of_year'</span><span class="p">])[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">orders</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemID</th>
      <th>day_of_year</th>
      <th>order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>23</td>
      <td>1</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>25</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1</td>
      <td>29</td>
      <td>307</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Adding-missing-item-day-combinations">
<a class="anchor" href="#Adding-missing-item-day-combinations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding missing item-day combinations<a class="anchor-link" href="#Adding-missing-item-day-combinations"> </a>
</h2>
<p>The aggregated data only contains entries for day-item pairs for which there is at least one transaction. This results in missing information:</p>
<ul>
<li>most items are only sold on a few days; no data on days with no orders is recorded</li>
<li>there are a few items that are never sold and therefore do not appear in <code>orders</code>
</li>
</ul>
<p>To account for the missing data, we add entries with <code>order = 0</code> for missing day-item combinations. This increases the number of observations from 100,771 to 1,883,340 and provides useful information about zero sales.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># add items that were never sold before</span>
<span class="n">missing_itemIDs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">missing_rows</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'itemID'</span><span class="p">:</span>     <span class="nb">list</span><span class="p">(</span><span class="n">missing_itemIDs</span><span class="p">),</span> 
                            <span class="s1">'day_of_year'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_itemIDs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int'</span><span class="p">),</span> 
                            <span class="s1">'order'</span><span class="p">:</span>       <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_itemIDs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int'</span><span class="p">)})</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orders</span><span class="p">,</span> <span class="n">missing_rows</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># add zeros for days with no transactions</span>
<span class="n">agg_orders</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'day_of_year'</span><span class="p">])</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">'day_of_year'</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">'day_of_year'</span><span class="p">,</span> <span class="n">dropna</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">agg_orders</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">agg_orders</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'day_of_year'</span><span class="p">,</span> <span class="s1">'order'</span><span class="p">]</span>
<span class="n">agg_orders</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">agg_orders</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">agg_orders</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(100771, 3)
(1883340, 3)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Labeling-promotions">
<a class="anchor" href="#Labeling-promotions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Labeling promotions<a class="anchor-link" href="#Labeling-promotions"> </a>
</h2>
<p>The data documentation says that promotions in the training data are not explicitly marked.</p>
<p>We need to manually mark promotion days. Ignoring it complicates forecasting because the number of orders in some days explodes without an apparent reason. In such cases, the underlying reason is likely a promotion, which should be reflected in a corresponding feature.</p>
<p>We need to be very careful about marking promotions. Labeling too many days as promotions based on the number of orders risks introducing data leakage since the number of orders is unknown at the prediction time. Below, I use <code>find_peaks()</code> to isolate peaks in the <code>order</code> time series and encode them as promotions:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># computations</span>
<span class="n">agg_orders</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">itemID</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
    <span class="n">promo</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span> <span class="o">==</span> <span class="n">itemID</span><span class="p">]))</span>
    <span class="n">avg</span>      <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span> <span class="o">==</span> <span class="n">itemID</span><span class="p">)][</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">std</span>      <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span> <span class="o">==</span> <span class="n">itemID</span><span class="p">)][</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span> <span class="o">==</span> <span class="n">itemID</span><span class="p">][</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">avg</span><span class="p">),</span> <span class="c1"># append avg to enable marking last point as promo</span>
                          <span class="n">prominence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>  <span class="c1"># peak difference with neighbor points; max(5,std) to exclude cases when std is too small</span>
                          <span class="n">height</span>     <span class="o">=</span> <span class="n">avg</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>  <span class="c1"># minimal height of a peak</span>
    <span class="n">promo</span><span class="p">[</span><span class="n">peaks</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">agg_orders</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span> <span class="o">==</span> <span class="n">itemID</span><span class="p">,</span> <span class="s1">'promotion'</span><span class="p">]</span> <span class="o">=</span> <span class="n">promo</span>

<span class="c1"># compare promotion number</span>
<span class="n">promo_in_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="n">promo_in_test</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">-</span> <span class="n">items</span><span class="o">.</span><span class="n">promotion_0</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">items</span><span class="o">.</span><span class="n">promotion_2</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">items</span><span class="o">.</span><span class="n">promotion_1</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="mi">14</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Daily p(promotion) per item in train: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">promo_in_train</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Daily p(promotion) per item in test:  </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">promo_in_test</span> <span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Daily p(promotion) per item in train: 0.0079
Daily p(promotion) per item in test:  0.0141
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our method identifies 14,911 promotions. Compared to the test set where promotions are explicitly reported, this amounts to about half as many promos per item and day.</p>
<p>Let's look visualize promotions for some items:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>

<span class="c1"># compute promo count</span>
<span class="n">promo_count</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'itemID'</span><span class="p">)[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">promo_count</span> <span class="o">=</span> <span class="n">promo_count</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'promotion'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># plot some items</span>
<span class="n">item_plots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10100</span><span class="p">,</span> <span class="mi">10200</span><span class="p">,</span> <span class="mi">10300</span><span class="p">,</span> <span class="mi">10400</span><span class="p">,</span> <span class="mi">10462</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item_plots</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[</span><span class="n">agg_orders</span><span class="o">.</span><span class="n">itemID</span> <span class="o">==</span> <span class="n">promo_count</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">][</span><span class="n">item_plots</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">'order'</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Total Orders'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Day'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/images/copied_from_nb/images/fig_promotions.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The yellow marker indicates promotions. Our method identifies some outliers as promos but misses a few points that are less prominent. At the same time, we can not be sure that these cases are necessarily promotions: the large number of orders on these days could be observed due to other reasons. We will stick to this solution but note that it might require further improvement.</p>
<h2 id="Feature-engineering">
<a class="anchor" href="#Feature-engineering" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feature engineering<a class="anchor-link" href="#Feature-engineering"> </a>
</h2>
<p>Now that the data is aggregated, we construct transaction-based features and the targets. For each day, we compute target as the total number of orders in the following 14 days. The days preceding the considered day are used to extract features. We extract slices of the past [1, 7, ..., 35] days and compute features based on data from that slice.</p>
<p>For each item, we compute the following features:</p>
<ul>
<li>total count of orders and ordered items</li>
<li>total count of promotions</li>
<li>mean item price</li>
<li>recency of the last order</li>
</ul>
<p>The number of orders and promotions is also aggregated on a manufacturer and category level.</p>
<p>In addition, we use <code>tsfresh</code> package to automatically extract features based on the order dynamics in the last 35 days. <code>tsfresh</code> computes hundreds of features describing the time series. We only keep features with no missing values.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># packages</span>
<span class="kn">from</span> <span class="nn">tsfresh</span> <span class="kn">import</span> <span class="n">extract_features</span>

<span class="c1"># parameters</span>
<span class="n">days_input</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>
<span class="n">days_target</span> <span class="o">=</span> <span class="mi">14</span>

<span class="c1"># preparations</span>
<span class="n">day_first</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">days_input</span><span class="p">)</span>
<span class="n">day_last</span>  <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">days_target</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">orders</span>    <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># merge manufacturer and category</span>
<span class="n">agg_orders</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items</span><span class="p">[[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'manufacturer'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">)</span>
<span class="n">agg_orders</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items</span><span class="p">[[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">]],</span>     <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">)</span>

<span class="c1"># computations</span>
<span class="k">for</span> <span class="n">day_of_year</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="n">day_last</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]):</span>    

    <span class="c1">### VALIDAION: TARGET, PROMOTIONS, PRICES</span>
        
    <span class="c1"># day intervals</span>
    <span class="n">target_day_min</span> <span class="o">=</span> <span class="n">day_of_year</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">target_day_max</span> <span class="o">=</span> <span class="n">day_of_year</span> <span class="o">+</span> <span class="n">days_target</span>
    
    <span class="c1"># compute target and promo: labeled data</span>
    <span class="k">if</span> <span class="n">day_of_year</span> <span class="o">&lt;</span> <span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
        
        <span class="c1"># target and future promo</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target_day_max</span><span class="p">)</span>
                           <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'itemID'</span><span class="p">)[</span><span class="s1">'order'</span><span class="p">,</span> <span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'target'</span><span class="p">,</span> <span class="s1">'promo_in_test'</span><span class="p">]</span>
        
        <span class="c1"># future price</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'mean_price_test'</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target_day_max</span><span class="p">)</span>
                                              <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'itemID'</span><span class="p">)[</span><span class="s1">'salesPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'salesPrice'</span><span class="p">]</span>
        
        <span class="c1"># merge manufacturer and category</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items</span><span class="p">[[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'itemID'</span><span class="p">)</span>
        
        <span class="c1"># future price per manufacturer</span>
        <span class="n">tmp_df_manufacturer</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                         <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target_day_max</span><span class="p">)</span>
                                         <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)[</span><span class="s1">'salesPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df_manufacturer</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'mean_price_test_manufacturer'</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_manufacturer</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'manufacturer'</span><span class="p">)</span>
        
        <span class="c1"># future price per category</span>
        <span class="n">tmp_df_category</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                     <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target_day_max</span><span class="p">)</span>
                                     <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)[</span><span class="s1">'salesPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df_category</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'category'</span><span class="p">,</span> <span class="s1">'mean_price_test_category'</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_category</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'category'</span><span class="p">)</span>
        
        <span class="c1"># future promo per manufacturer</span>
        <span class="n">tmp_df_manufacturer</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                         <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target_day_max</span><span class="p">)</span>
                                         <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df_manufacturer</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'promo_in_test_manufacturer'</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_manufacturer</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'manufacturer'</span><span class="p">)</span>

        <span class="c1"># future promo per category</span>
        <span class="n">tmp_df_category</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                     <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target_day_max</span><span class="p">)</span>
                                     <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df_category</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'category'</span><span class="p">,</span> <span class="s1">'promo_in_test_category'</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_category</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'category'</span><span class="p">)</span>
                       
        
    <span class="c1"># compute target and promo: unlabeled data</span>
    <span class="k">else</span><span class="p">:</span>
        
        <span class="c1"># placeholders</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'itemID'</span><span class="p">:</span>                     <span class="n">items</span><span class="o">.</span><span class="n">itemID</span><span class="p">,</span>
                               <span class="s1">'target'</span><span class="p">:</span>                     <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                               <span class="s1">'promo_in_test'</span><span class="p">:</span>              <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                               <span class="s1">'mean_price_test'</span><span class="p">:</span>            <span class="n">items</span><span class="o">.</span><span class="n">simulationPrice</span><span class="p">,</span>
                               <span class="s1">'manufacturer'</span><span class="p">:</span>               <span class="n">items</span><span class="o">.</span><span class="n">manufacturer</span><span class="p">,</span>
                               <span class="s1">'category'</span><span class="p">:</span>                   <span class="n">items</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
                               <span class="s1">'promo_in_test_manufacturer'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                               <span class="s1">'promo_in_test_category'</span><span class="p">:</span>     <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>

        
    <span class="c1">### TRAINING: LAG-BASED FEATURES</span>
            
    <span class="c1"># compute features</span>
    <span class="k">for</span> <span class="n">day_input</span> <span class="ow">in</span> <span class="n">days_input</span><span class="p">:</span>
        
        <span class="c1"># day intervals</span>
        <span class="n">input_day_min</span>  <span class="o">=</span> <span class="n">day_of_year</span> <span class="o">-</span> <span class="n">day_input</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">input_day_max</span>  <span class="o">=</span> <span class="n">day_of_year</span>
    
        <span class="c1"># frequency, promo and price</span>
        <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">input_day_max</span><span class="p">)</span>
                                 <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'itemID'</span><span class="p">)</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'order_sum_last_'</span>   <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'order'</span><span class="p">]</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'order_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'order'</span><span class="p">]</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'promo_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'promotion'</span><span class="p">]</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'mean_price_last_'</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'salesPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'salesPrice'</span><span class="p">]</span>

        <span class="c1"># frequency, promo per manufacturer</span>
        <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">input_day_max</span><span class="p">)</span>
                                 <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)</span>
        <span class="n">tmp_df_manufacturer</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df_manufacturer</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'order_manufacturer_sum_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span>
        <span class="n">tmp_df_manufacturer</span><span class="p">[</span><span class="s1">'order_manufacturer_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'order'</span><span class="p">]</span>
        <span class="n">tmp_df_manufacturer</span><span class="p">[</span><span class="s1">'promo_manufacturer_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'promotion'</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_manufacturer</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'manufacturer'</span><span class="p">)</span>
    
        <span class="c1"># frequency, promo per category</span>
        <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">input_day_max</span><span class="p">)</span>
                                 <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
        <span class="n">tmp_df_category</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp_df_category</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'category'</span><span class="p">,</span> <span class="s1">'order_category_sum_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span>       
        <span class="n">tmp_df_category</span><span class="p">[</span><span class="s1">'order_category_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'order'</span><span class="p">]</span>
        <span class="n">tmp_df_category</span><span class="p">[</span><span class="s1">'promo_category_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'promotion'</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_category</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'category'</span><span class="p">)</span>

        <span class="c1"># frequency, promo per all items</span>
        <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">input_day_max</span><span class="p">)]</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'order_all_sum_last_'</span>   <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'order_all_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'promo_all_count_last_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day_input</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'promotion'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span>
        
        <span class="c1"># recency</span>
        <span class="k">if</span> <span class="n">day_input</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">days_input</span><span class="p">):</span>
            <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">input_day_max</span><span class="p">)</span> <span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                                     <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'itemID'</span><span class="p">)</span>
            <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'days_since_last_order'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">day_of_year</span> <span class="o">-</span> <span class="n">tmp_df_input</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'max'</span><span class="p">))</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">tmp_df</span><span class="o">.</span><span class="n">itemID</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">'day_of_year'</span><span class="p">]</span>
            <span class="n">tmp_df</span><span class="p">[</span><span class="s1">'days_since_last_order'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">day_input</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            
            
        <span class="c1"># tsfresh features</span>
        <span class="k">if</span> <span class="n">day_input</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">days_input</span><span class="p">):</span>
            <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">agg_orders</span><span class="p">[(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_day_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                      <span class="p">(</span><span class="n">agg_orders</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">input_day_max</span><span class="p">)]</span>
            <span class="n">tmp_df_input</span> <span class="o">=</span> <span class="n">tmp_df_input</span><span class="p">[[</span><span class="s1">'day_of_year'</span><span class="p">,</span> <span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'order'</span><span class="p">]]</span>
            <span class="n">extracted_features</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">tmp_df_input</span><span class="p">,</span> <span class="n">column_id</span> <span class="o">=</span> <span class="s1">'itemID'</span><span class="p">,</span> <span class="n">column_sort</span> <span class="o">=</span> <span class="s1">'day_of_year'</span><span class="p">)</span>
            <span class="n">extracted_features</span><span class="p">[</span><span class="s1">'itemID'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_features</span><span class="o">.</span><span class="n">index</span>
            <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extracted_features</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'itemID'</span><span class="p">)</span>
            
            
    <span class="c1">### FINAL PREPARATIONS</span>
            
    <span class="c1"># day of year</span>
    <span class="n">tmp_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s1">'day_of_year'</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">day_of_year</span><span class="p">)</span>
        
    <span class="c1"># merge data</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orders</span><span class="p">,</span> <span class="n">tmp_df</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># drop manufacturer and category</span>
    <span class="k">del</span> <span class="n">orders</span><span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">orders</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span>


<span class="c1">##### REMOVE MISSINGS</span>

<span class="n">good_nas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'target'</span><span class="p">,</span> 
            <span class="s1">'mean_price_test_category'</span><span class="p">,</span> <span class="s1">'mean_price_test_manufacturer'</span><span class="p">,</span>
            <span class="s1">'promo_in_test'</span><span class="p">,</span> <span class="s1">'promo_in_test_category'</span><span class="p">,</span> <span class="s1">'promo_in_test_manufacturer'</span><span class="p">]</span>
<span class="n">nonas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">orders</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">good_nas</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">nonas</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="c1">##### COMPUTE MEAN PRICE RATIOS</span>

<span class="nb">print</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">price_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'mean_price_last_1'</span><span class="p">,</span> <span class="s1">'mean_price_last_7'</span><span class="p">,</span> <span class="s1">'mean_price_last_14'</span><span class="p">,</span> 
              <span class="s1">'mean_price_last_21'</span><span class="p">,</span> <span class="s1">'mean_price_last_28'</span><span class="p">,</span> <span class="s1">'mean_price_last_35'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">price_vars</span><span class="p">:</span>
    <span class="n">orders</span><span class="p">[</span><span class="s1">'ratio_'</span>              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="s1">'mean_price_test'</span><span class="p">]</span>              <span class="o">/</span> <span class="n">orders</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">orders</span><span class="p">[</span><span class="s1">'ratio_manufacturer_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="s1">'mean_price_test_manufacturer'</span><span class="p">]</span> <span class="o">/</span> <span class="n">orders</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">orders</span><span class="p">[</span><span class="s1">'ratio_category_'</span>     <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="s1">'mean_price_test_category'</span><span class="p">]</span>     <span class="o">/</span> <span class="n">orders</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(1391579, 458)
(1391579, 470)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The feature extraction takes about ten hours and outputs a data set with 470 features. Great job!</p>
<p>Now, let's create features in the <code>items</code> data set:</p>
<ul>
<li>ratio of the actual and recommended price</li>
<li>item category index constructed of three subcategories</li>
<li>customer rating relative to the average rating of the items of the same manufacturer or category</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># price ratio</span>
<span class="n">items</span><span class="p">[</span><span class="s1">'recommended_simulation_price_ratio'</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span> <span class="o">/</span> <span class="n">items</span><span class="p">[</span><span class="s1">'recommendedRetailPrice'</span><span class="p">]</span>

<span class="c1"># detailed item category</span>
<span class="n">items</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="s1">'category1'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">items</span><span class="p">[</span><span class="s1">'category2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">items</span><span class="p">[</span><span class="s1">'category3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">items</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># customer rating ratio per manufacturer</span>
<span class="n">rating_manufacturer</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)[</span><span class="s1">'customerRating'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">rating_manufacturer</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'mean_customerRating_manufacturer'</span><span class="p">]</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rating_manufacturer</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'manufacturer'</span><span class="p">)</span>
<span class="n">items</span><span class="p">[</span><span class="s1">'customerRating_manufacturer_ratio'</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="s1">'customerRating'</span><span class="p">]</span> <span class="o">/</span> <span class="n">items</span><span class="p">[</span><span class="s1">'mean_customerRating_manufacturer'</span><span class="p">]</span>
<span class="k">del</span> <span class="n">items</span><span class="p">[</span><span class="s1">'mean_customerRating_manufacturer'</span><span class="p">]</span>

<span class="c1"># customer rating ratio per category</span>
<span class="n">rating_category</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)[</span><span class="s1">'customerRating'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">rating_category</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'category'</span><span class="p">,</span> <span class="s1">'mean_customerRating_category'</span><span class="p">]</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rating_category</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'category'</span><span class="p">)</span>
<span class="n">items</span><span class="p">[</span><span class="s1">'customerRating_category_ratio'</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="s1">'customerRating'</span><span class="p">]</span> <span class="o">/</span> <span class="n">items</span><span class="p">[</span><span class="s1">'mean_customerRating_category'</span><span class="p">]</span>
<span class="k">del</span> <span class="n">items</span><span class="p">[</span><span class="s1">'mean_customerRating_category'</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can now merge <code>orders</code> and <code>items</code>. We also partition the data into the labeled training set and the unlabeled test set, compute some missing features for the test set and export the data as csv.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>

<span class="c1">##### DATA PARTITIONING</span>

<span class="c1"># merge data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'itemID'</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">)</span>

<span class="c1"># partition intro train and test</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">df</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>


<span class="c1">##### COMPUTE FEATURES FOR TEST DATA</span>

<span class="c1"># add promotion info to test</span>
<span class="n">promo_vars</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span> <span class="o">=</span> <span class="s1">'promotion_'</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">'promo_in_test'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">df_test</span><span class="p">[</span><span class="n">promo_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">'promo_in_test'</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

<span class="k">del</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'promo_in_test_manufacturer'</span><span class="p">],</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'promo_in_test_category'</span><span class="p">]</span>

<span class="c1"># future promo per manufacturer</span>
<span class="n">tmp_df_manufacturer</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)[</span><span class="s1">'promo_in_test'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">tmp_df_manufacturer</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'promo_in_test_manufacturer'</span><span class="p">]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_manufacturer</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'manufacturer'</span><span class="p">)</span>

<span class="c1"># future promo per category</span>
<span class="n">tmp_df_category</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)[</span><span class="s1">'promo_in_test'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">tmp_df_category</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'category'</span><span class="p">,</span> <span class="s1">'promo_in_test_category'</span><span class="p">]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_category</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'category'</span><span class="p">)</span>

<span class="k">del</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'mean_price_test_manufacturer'</span><span class="p">],</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'mean_price_test_category'</span><span class="p">]</span>

<span class="c1"># future price per manufacturer</span>
<span class="n">tmp_df_manufacturer</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)[</span><span class="s1">'mean_price_test'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">tmp_df_manufacturer</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'manufacturer'</span><span class="p">,</span> <span class="s1">'mean_price_test_manufacturer'</span><span class="p">]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_manufacturer</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'manufacturer'</span><span class="p">)</span>

<span class="c1"># future price per category</span>
<span class="n">tmp_df_category</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)[</span><span class="s1">'mean_price_test'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">tmp_df_category</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'category'</span><span class="p">,</span> <span class="s1">'mean_price_test_category'</span><span class="p">]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_category</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">'left'</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">'category'</span><span class="p">)</span>

<span class="c1"># mean price ratios</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">price_vars</span><span class="p">:</span>
    <span class="n">df_test</span><span class="p">[</span><span class="s1">'ratio_'</span>              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'mean_price_test'</span><span class="p">]</span>              <span class="o">/</span> <span class="n">df_test</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">df_test</span><span class="p">[</span><span class="s1">'ratio_manufacturer_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'mean_price_test_manufacturer'</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_test</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">df_test</span><span class="p">[</span><span class="s1">'ratio_category_'</span>     <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">'mean_price_test_category'</span><span class="p">]</span>     <span class="o">/</span> <span class="n">df_test</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>


<span class="c1">##### DROP FEATURES</span>

<span class="c1"># drop promotion dates</span>
<span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">promo_vars</span><span class="p">,</span>  <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">promo_vars</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># drop mean prices</span>
<span class="n">price_vars</span> <span class="o">=</span> <span class="n">price_vars</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'mean_price_test_manufacturer'</span><span class="p">,</span> <span class="s1">'mean_price_test_category'</span><span class="p">]</span>
<span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">price_vars</span><span class="p">,</span>  <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">price_vars</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># export data</span>
<span class="n">save_csv_version</span><span class="p">(</span><span class="s1">'../data/prepared/df.csv'</span><span class="p">,</span>      <span class="n">df_train</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">'gzip'</span><span class="p">)</span>
<span class="n">save_csv_version</span><span class="p">(</span><span class="s1">'../data/prepared/df_test.csv'</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span>  <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">'gzip'</span><span class="p">,</span> <span class="n">min_version</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Saved as ../data/prepared/df_v14.csv
Saved as ../data/prepared/df_test_v14.csv
(1381116, 476)
(10463, 476)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="4.-Modeling">
<a class="anchor" href="#4.-Modeling" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. Modeling<a class="anchor-link" href="#4.-Modeling"> </a>
</h1>
<h2 id="Custom-loss-functions">
<a class="anchor" href="#Custom-loss-functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom loss functions<a class="anchor-link" href="#Custom-loss-functions"> </a>
</h2>
<p>Machine learning encompasses a wide range of statically-inspired performance metrics such as MSE, MAE and others. In practice, machine learning models are used by a company that has specific goals. Usually, these goals can not be expressed in terms of such simple metrics. Therefore, it is important to come up with an evaluation metric consistent with the company's objectives to ensure that we judge performance on a criterion that actually matters.</p>
<p>In the DMC 2020 task, we are given a profit function of the retailer. The function accounts for asymmetric error costs: underpredicting demand results in lost revenue because the retailer can not sell a product that is not ready to ship, whereas overpredicting demand incurs a fee for storing the excessive amount of product.</p>
<p>Below, we derive profit according to the task description:</p>
<p><img src="/images/copied_from_nb/images/fig_profit.png" alt=""></p>
<p>Let's implement the profit function in Python:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">profit</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Computes retailer's profit.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">    - y_true (numpy array): ground truth demand values</span>
<span class="sd">    - y_pred (numpy array): predicted demand values</span>
<span class="sd">    - price (numpy array): item prices</span>

<span class="sd">    Returns:</span>
<span class="sd">    - profit value</span>
<span class="sd">    '''</span>

    <span class="c1"># remove negative and round</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int'</span><span class="p">)</span>

    <span class="c1"># sold units</span>
    <span class="n">units_sold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># overstocked units</span>
    <span class="n">units_overstock</span> <span class="o">=</span> <span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span>
    <span class="n">units_overstock</span><span class="p">[</span><span class="n">units_overstock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># profit</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="n">units_sold</span> <span class="o">*</span> <span class="n">price</span>
    <span class="n">fee</span>     <span class="o">=</span> <span class="n">units_overstock</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.6</span>
    <span class="n">profit</span>  <span class="o">=</span> <span class="n">revenue</span> <span class="o">-</span> <span class="n">fee</span>
    <span class="n">profit</span>  <span class="o">=</span> <span class="n">profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">profit</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The function above is great for evaluating quality of our predictions. But can we directly optimize it during modeling?</p>
<p>LightGBM supports custom loss functions on both training and validation stages. To use a custom loss during training, one needs to supply a function with its first and second-order derivatives.</p>
<p>Ideally, we would like to define the loss as a difference between the potential profit (given our demand prediction) and the oracle profit (when demand prediction is correct). However, such a loss is not differentiable. We can not compute derivatives to plug it as a training loss. Instead, we need to come up with a slightly different function that approximates profit and satisfies the loss conditions.</p>
<p>We define the loss as a squared difference between the oracle profit and profit based on predicted demand. In this setting, we can compute loss derivatives with respect to the prediction (Gradient and Hessian):</p>
<p><img src="/images/copied_from_nb/images/fig_loss.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The snippet below implements the training and validation losses for LightGBM. You can notice that we do not include the squared prices in the loss functions. The reason is that with <code>sklearn</code> API, it is difficult to include external variables like prices in the loss, so we will include the price later.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collpase-show</span>

<span class="c1">##### TRAINING LOSS</span>
<span class="k">def</span> <span class="nf">asymmetric_mse</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Asymmetric MSE objective for training LightGBM regressor.</span>
<span class="sd">     </span>
<span class="sd">    Arguments:</span>
<span class="sd">    - y_true (numpy array): ground truth target values</span>
<span class="sd">    - y_pred (numpy array): estimated target values</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    - gradient</span>
<span class="sd">    - hessian</span>
<span class="sd">    '''</span>
    
    <span class="n">residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">)</span>    
    <span class="n">grad</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">residual</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">residual</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.72</span><span class="o">*</span><span class="n">residual</span><span class="p">)</span>
    <span class="n">hess</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">residual</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>  <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grad</span><span class="p">,</span> <span class="n">hess</span>


<span class="c1">##### VALIDATION LOSS</span>
<span class="k">def</span> <span class="nf">asymmetric_mse_eval</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    
    <span class="sd">'''</span>
<span class="sd">    Asymmetric MSE evaluation metric for evaluating LightGBM regressor.</span>
<span class="sd">     </span>
<span class="sd">    Arguments:</span>
<span class="sd">    - y_true (numpy array): ground truth target values</span>
<span class="sd">    - y_pred (numpy array): estimated target values</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    - metric name</span>
<span class="sd">    - metric value</span>
<span class="sd">    - whether the metric is maximized</span>
<span class="sd">    '''</span>
    
    <span class="n">residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">)</span>      
    <span class="n">loss</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">residual</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">residual</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.72</span><span class="o">*</span><span class="n">residual</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'asymmetric_mse_eval'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">),</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How to deal with the prices?</p>
<p>One option is to account for them within the <code>fit()</code> method. LightGBM supports weighing observations using the arguments <code>sample_weight</code> and <code>eval_sample_weight</code>. You will see how we supply price vectors in the modeling code in the next section. Note that including prices as weights instead of plugging them into the loss leads to losing some information, since Gradients and Hessians are computed without the price multiplication. Still, this approach provides a pretty close approximation of the original profit function. If you are interested in including prices in the loss, you can check <code>lightGBM</code> API that allows more flexibility.</p>
<p>The only missing piece is the relationship between the penalty size and the prediction error. By taking a square root of the profit differences instead of the absolute value, we penalize larger errors more than the smaller ones. However, our profit changes linearly with the error size. This is how we can can address it:</p>
<ul>
<li>transform target using a non-linear transformation (e.g. square root)</li>
<li>train a model that optimizes the MSE loss on the transformed target </li>
<li>apply the inverse transformation to the model predictions</li>
</ul>
<p>Target transformation smooths out the square effect in MSE. We still penalize large errors more, but the large errors on a transformed scale are also smaller compared to the original scale. This helps to balance the two effects and approximate a linear relationship between the error size and the loss penalty.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modeling-pipeline">
<a class="anchor" href="#Modeling-pipeline" aria-hidden="true"><span class="octicon octicon-link"></span></a>Modeling pipeline<a class="anchor-link" href="#Modeling-pipeline"> </a>
</h2>
<p>Good, let's start building models! First, we extract the target and flag ID features not used for prediction.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>

<span class="c1"># extract target</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">'target'</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'target'</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">del</span> <span class="n">df_train</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># format test data</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'target'</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">del</span> <span class="n">df_test</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># relevant features</span>
<span class="n">drop_feats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'itemID'</span><span class="p">,</span> <span class="s1">'day_of_year'</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_feats</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(1381116, 475) (1381116,)
(10463, 475)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The modeling pipeline uses multiple tricks discovered during the model refinement process. We toggle these tricks using logical variables that define the following training options:</p>
<ul>
<li>
<code>target_transform = True</code>: transforms target to reduce penalty for large errors. Motivation for this is provided in the previous section.</li>
<li>
<code>train_on_positive = False</code>: trains only on cases with positive sales (i.e., at least one of the order lags is greater than zero) and predicts null demand for items with no sales. This substantially reduces the training time but also leads to a drop in the performance.</li>
<li>
<code>two_stage = True</code>: trains a two-stage model: (i) binary classifier predicting whether the future sales will be zero; (ii) regression model predicting the volume of sales. Predictions of the regression model are only stored for cases where the classifier predicts positive sales.</li>
<li>
<code>tuned_params = True</code>: imports optimized LightGBM hyper-parameter values. The next section describes the tuning procedure.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>

<span class="c1">##### TRAINING OPTIONS</span>

<span class="c1"># target transformation</span>
<span class="n">target_transform</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># train on positive sales only</span>
<span class="n">train_on_positive</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># two-stage model</span>
<span class="n">two_stage</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># use tuned meta-params</span>
<span class="n">tuned_params</span> <span class="o">=</span> <span class="kc">True</span>


<span class="c1">##### CLASSIFIER PARAMETERS</span>

<span class="c1"># rounds and options</span>
<span class="n">cores</span>       <span class="o">=</span> <span class="mi">4</span>
<span class="n">stop_rounds</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">verbose</span>     <span class="o">=</span> <span class="mi">100</span>
<span class="n">seed</span>        <span class="o">=</span> <span class="mi">23</span>

<span class="c1"># LGB parameters</span>
<span class="n">lgb_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'boosting_type'</span><span class="p">:</span>    <span class="s1">'goss'</span><span class="p">,</span>
    <span class="s1">'objective'</span><span class="p">:</span>        <span class="n">asymmetric_mse</span><span class="p">,</span>
    <span class="s1">'metrics'</span><span class="p">:</span>          <span class="n">asymmetric_mse_eval</span><span class="p">,</span>
    <span class="s1">'n_estimators'</span><span class="p">:</span>     <span class="mi">1000</span><span class="p">,</span>
    <span class="s1">'learning_rate'</span><span class="p">:</span>    <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">'bagging_fraction'</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">'feature_fraction'</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">'lambda_l1'</span><span class="p">:</span>        <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">'lambda_l2'</span><span class="p">:</span>        <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">'silent'</span><span class="p">:</span>           <span class="kc">True</span><span class="p">,</span>
    <span class="s1">'verbosity'</span><span class="p">:</span>        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s1">'nthread'</span> <span class="p">:</span>         <span class="n">cores</span><span class="p">,</span>
    <span class="s1">'random_state'</span><span class="p">:</span>     <span class="n">seed</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># load optimal parameters</span>
<span class="k">if</span> <span class="n">tuned_params</span><span class="p">:</span>
    <span class="n">par_file</span>   <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'../lgb_meta_params_100.pkl'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
    <span class="n">lgb_params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
    <span class="n">lgb_params</span><span class="p">[</span><span class="s1">'nthread'</span><span class="p">]</span>      <span class="o">=</span> <span class="n">cores</span>
    <span class="n">lgb_params</span><span class="p">[</span><span class="s1">'random_state'</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>

<span class="c1"># second-stage LGB</span>
<span class="k">if</span> <span class="n">two_stage</span><span class="p">:</span>
    <span class="n">lgb_classifier_params</span>              <span class="o">=</span> <span class="n">lgb_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">lgb_classifier_params</span><span class="p">[</span><span class="s1">'objective'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'binary'</span>
    <span class="n">lgb_classifier_params</span><span class="p">[</span><span class="s1">'metrics'</span><span class="p">]</span>   <span class="o">=</span> <span class="s1">'logloss'</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We also define the partitioning parameters. We use a sliding window approach with 7 folds, where each subsequent fold is shifted by one day into the past.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="n">num_folds</span> <span class="o">=</span> <span class="mi">7</span>   <span class="c1"># no. CV folds</span>
<span class="n">test_days</span> <span class="o">=</span> <span class="mi">14</span>  <span class="c1"># no. days in the test set</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's explain the partitioning using the first fold as an example. Each fold is divided into training and validation subsets. The first 35 days are cut off and only used to compute lag-based features for the days starting from 36. Days 36 - 145 are used for training. For each of these days, we have features based on the previous 35 days and targets based on the next 14 days. Days 159 - 173 are used for validation. Days 146 - 158 between training and validation subsets are skipped to avoid data leakage: the target for these days would use information from the validation period.</p>
<p><img src="/images/copied_from_nb/images/fig_partitioning.png" alt=""></p>
<p>We can now set up a modeling loop with the following steps for each of the folds:</p>
<ul>
<li>extract data from the fold and partition it into training and validation sets</li>
<li>train LightGBM on the training set and perform early stopping on the validation set</li>
<li>save predictions for the validation set (denoted as OOF) and predictions for the test set</li>
<li>save feature importance and performance on the validation fold</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># placeholders</span>
<span class="n">importances</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">preds_oof</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">reals_oof</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">prices_oof</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">preds_test</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">oof_rmse</span>      <span class="o">=</span> <span class="p">[]</span>
<span class="n">oof_profit</span>    <span class="o">=</span> <span class="p">[]</span>
<span class="n">oracle_profit</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">clfs</span>          <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_idx</span>     <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_idx</span>     <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># objects</span>
<span class="n">train_days</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">test_days</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">num_folds</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1"># no. days in the train set</span>
<span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># modeling loop</span>
<span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
    
    <span class="c1">##### PARTITIONING</span>
    
    <span class="c1"># dates</span>
    <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">v_end</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">'day_of_year'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_end</span> <span class="o">=</span> <span class="n">v_end</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">v_start</span> <span class="o">=</span> <span class="n">v_end</span>
    <span class="n">t_end</span>   <span class="o">=</span> <span class="n">v_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">test_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_end</span>   <span class="o">-</span> <span class="p">(</span><span class="n">train_days</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># extract index</span>
    <span class="n">train_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&gt;=</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&lt;=</span> <span class="n">t_end</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">valid_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&gt;=</span> <span class="n">v_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&lt;=</span> <span class="n">v_end</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>   
    
    <span class="c1"># extract samples</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]][</span><span class="n">features</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]]</span>
    <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]][</span><span class="n">features</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    
    <span class="c1"># keep positive cases</span>
    <span class="k">if</span> <span class="n">train_on_positive</span><span class="p">:</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X_train</span><span class="p">[</span><span class="s1">'order_sum_last_28'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="s1">'promo_in_test'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X_train</span><span class="p">[</span><span class="s1">'order_sum_last_28'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="s1">'promo_in_test'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'- train period days: </span><span class="si">{}</span><span class="s1"> -- </span><span class="si">{}</span><span class="s1"> (n = </span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">])))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'- valid period days: </span><span class="si">{}</span><span class="s1"> -- </span><span class="si">{}</span><span class="s1"> (n = </span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_start</span><span class="p">,</span> <span class="n">v_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">])))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>

    
    <span class="c1">##### MODELING</span>
    
    <span class="c1"># target transformation</span>
    <span class="k">if</span> <span class="n">target_transform</span><span class="p">:</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)</span>
        
    <span class="c1"># first stage model</span>
    <span class="k">if</span> <span class="n">two_stage</span><span class="p">:</span>
        <span class="n">y_train_binary</span><span class="p">,</span> <span class="n">y_valid_binary</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y_valid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_train_binary</span><span class="p">[</span><span class="n">y_train_binary</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">y_valid_binary</span><span class="p">[</span><span class="n">y_valid_binary</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">clf_classifier</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">lgb_classifier_params</span><span class="p">)</span> 
        <span class="n">clf_classifier</span> <span class="o">=</span> <span class="n">clf_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_binary</span><span class="p">,</span> 
                                            <span class="n">eval_set</span>              <span class="o">=</span> <span class="p">[(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_binary</span><span class="p">),</span> <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid_binary</span><span class="p">)],</span>
                                            <span class="n">eval_metric</span>           <span class="o">=</span> <span class="s1">'logloss'</span><span class="p">,</span>
                                            <span class="n">early_stopping_rounds</span> <span class="o">=</span> <span class="n">stop_rounds</span><span class="p">,</span>
                                            <span class="n">verbose</span>               <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">preds_oof_fold_binary</span>  <span class="o">=</span> <span class="n">clf_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
        <span class="n">preds_test_fold_binary</span> <span class="o">=</span> <span class="n">clf_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># training</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">lgb_params</span><span class="p">)</span> 
    <span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                  <span class="n">eval_set</span>              <span class="o">=</span> <span class="p">[(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)],</span> 
                  <span class="n">eval_metric</span>           <span class="o">=</span> <span class="n">asymmetric_mse_eval</span><span class="p">,</span>
                  <span class="n">sample_weight</span>         <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                  <span class="n">eval_sample_weight</span>    <span class="o">=</span> <span class="p">[</span><span class="n">X_train</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
                  <span class="n">early_stopping_rounds</span> <span class="o">=</span> <span class="n">stop_rounds</span><span class="p">,</span>
                  <span class="n">verbose</span>               <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">clfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>
    
    <span class="c1"># inference</span>
    <span class="k">if</span> <span class="n">target_transform</span><span class="p">:</span>      
        <span class="n">preds_oof_fold</span>  <span class="o">=</span> <span class="n">postprocess_preds</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">reals_oof_fold</span>  <span class="o">=</span> <span class="n">y_valid</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">preds_test_fold</span> <span class="o">=</span> <span class="n">postprocess_preds</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_folds</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">preds_oof_fold</span>  <span class="o">=</span> <span class="n">postprocess_preds</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">))</span>
        <span class="n">reals_oof_fold</span>  <span class="o">=</span> <span class="n">y_valid</span>
        <span class="n">preds_test_fold</span> <span class="o">=</span> <span class="n">postprocess_preds</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span> <span class="o">/</span> <span class="n">num_folds</span>
        
    <span class="c1"># impute zeros</span>
    <span class="k">if</span> <span class="n">train_on_positive</span><span class="p">:</span>
        <span class="n">preds_oof_fold</span><span class="p">[(</span><span class="n">X_valid</span><span class="p">[</span><span class="s1">'order_sum_last_28'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X_valid</span><span class="p">[</span><span class="s1">'promo_in_test'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">preds_test_fold</span><span class="p">[(</span><span class="n">X_test</span><span class="p">[</span><span class="s1">'order_sum_last_28'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="s1">'promo_in_test'</span><span class="p">]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="c1"># multiply with first stage predictions</span>
    <span class="k">if</span> <span class="n">two_stage</span><span class="p">:</span>
        <span class="n">preds_oof_fold</span>  <span class="o">=</span> <span class="n">preds_oof_fold</span>  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">preds_oof_fold_binary</span><span class="p">)</span>
        <span class="n">preds_test_fold</span> <span class="o">=</span> <span class="n">preds_test_fold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">preds_test_fold_binary</span><span class="p">)</span>

    <span class="c1"># write predictions</span>
    <span class="n">preds_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">preds_oof_fold</span>
    <span class="n">reals_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">reals_oof_fold</span>
    <span class="n">preds_test</span>        <span class="o">+=</span> <span class="n">preds_test_fold</span>
    
    <span class="c1"># save prices</span>
    <span class="n">prices_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]][</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        
    <span class="c1">##### EVALUATION</span>

    <span class="c1"># evaluation</span>
    <span class="n">oof_rmse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">reals_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:],</span> 
                                               <span class="n">preds_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:])))</span>
    <span class="n">oof_profit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profit</span><span class="p">(</span><span class="n">reals_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:],</span> 
                             <span class="n">preds_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:],</span> 
                             <span class="n">price</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]][</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">oracle_profit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profit</span><span class="p">(</span><span class="n">reals_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:],</span> 
                                <span class="n">reals_oof</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="p">:],</span> 
                                <span class="n">price</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">[</span><span class="n">fold</span><span class="p">]][</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    
    <span class="c1"># feature importance</span>
    <span class="n">fold_importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">fold_importance_df</span><span class="p">[</span><span class="s1">'Feature'</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
    <span class="n">fold_importance_df</span><span class="p">[</span><span class="s1">'Importance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="n">fold_importance_df</span><span class="p">[</span><span class="s1">'Fold'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">importances</span><span class="p">,</span> <span class="n">fold_importance_df</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'FOLD </span><span class="si">{:d}</span><span class="s1">/</span><span class="si">{:d}</span><span class="s1">: RMSE = </span><span class="si">{:.2f}</span><span class="s1">, PROFIT = </span><span class="si">{:.0f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
                                                                  <span class="n">num_folds</span><span class="p">,</span> 
                                                                  <span class="n">oof_rmse</span><span class="p">[</span><span class="n">fold</span><span class="p">],</span> 
                                                                  <span class="n">oof_profit</span><span class="p">[</span><span class="n">fold</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    

<span class="c1"># print performance</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'- AVERAGE RMSE:   </span><span class="si">{:.2f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oof_rmse</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'- AVERAGE PROFIT: </span><span class="si">{:.0f}</span><span class="s1"> (</span><span class="si">{:.2f}</span><span class="s1">%)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oof_profit</span><span class="p">),</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oof_profit</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oracle_profit</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'- RUNNING TIME:   </span><span class="si">{:.2f}</span><span class="s1"> minutes'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>-----------------------------------------------------------------
- train period days: 41 -- 151 (n = 1161393)
- valid period days: 166 -- 166 (n = 10463)
-----------------------------------------------------------------
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[532]	training's binary_logloss: 0.238417	valid_1's binary_logloss: 0.347182
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[788]	training's rmse: 0.611924	training's asymmetric_mse_eval: 2.82734	valid_1's rmse: 0.98004	valid_1's asymmetric_mse_eval: 5.83945
-----------------------------------------------------------------
FOLD 1/7: RMSE = 74.46, PROFIT = 4146664
-----------------------------------------------------------------

...

-----------------------------------------------------------------
- train period days: 35 -- 145 (n = 1161393)
- valid period days: 160 -- 160 (n = 10463)
-----------------------------------------------------------------
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[711]	training's binary_logloss: 0.22193	valid_1's binary_logloss: 0.338637
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[782]	training's rmse: 0.600011	training's asymmetric_mse_eval: 2.71385	valid_1's rmse: 0.987073	valid_1's asymmetric_mse_eval: 5.67223
-----------------------------------------------------------------
FOLD 7/7: RMSE = 74.46, PROFIT = 3958098
-----------------------------------------------------------------


-----------------------------------------------------------------
- AVERAGE RMSE:   69.66
- AVERAGE PROFIT: 3997598 (54.19%)
- RUNNING TIME:   88.53 minutes
-----------------------------------------------------------------
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looks good! The modeling pipeline took us about 1.5 hours to run.</p>
<p>Forecasting demand with our models results in 3,997,598 daily profit, which is about 54% of the maximum possible profit. Let's visualize the results:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># residual plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">reals_oof</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">preds_oof</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axis_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">reals_oof</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">preds_oof</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">top</span>   <span class="o">=</span> <span class="mf">1.02</span><span class="o">*</span><span class="n">axis_lim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">right</span> <span class="o">=</span> <span class="mf">1.02</span><span class="o">*</span><span class="n">axis_lim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis_lim</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis_lim</span><span class="p">),</span> <span class="s1">'r--'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Residual Plot'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Predicted demand'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Actual demand'</span><span class="p">)</span>

<span class="c1"># feature importance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">top_feats</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">importances</span><span class="p">[[</span><span class="s1">'Feature'</span><span class="p">,</span> <span class="s1">'Importance'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'Feature'</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">'Importance'</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_feats</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">importance</span> <span class="o">=</span> <span class="n">importances</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">importances</span><span class="o">.</span><span class="n">Feature</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">'Importance'</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">'Feature'</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">importance</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">'Importance'</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span> <span class="n">ci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Feature Importance'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/images/copied_from_nb/images/fig_lgb_perf.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The scatterplot shows that there is a space for further improvement: many predictions are far from the 45-degree line where predicted and real orders are equal. The important features mostly contain price information followed by features that count the previous orders.</p>
<p>We can now use predictions stored in <code>preds_test</code> to create a submission. Mission accomplished!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="5.-Hyper-parameter-tuning">
<a class="anchor" href="#5.-Hyper-parameter-tuning" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Hyper-parameter tuning<a class="anchor-link" href="#5.-Hyper-parameter-tuning"> </a>
</h1>
<p>One way to improve our solution is to optimize the LightGBM hyper-parameters.</p>
<p>We tune hyper-parameters using the <code>hyperopt</code> package, which performs optimization using Tree of Parzen Estimators (TPE) as a search algorithm. You don't really need to know how TPE works. As a user, you are only required to supply a parameter grid indicating the range of possible values. Compared to standard tuning methods like grid search or random search, TPE explores the search space more efficiently, allowing you to find a suitable solution faster. If you want to read more, see the package documentation <a href="http://hyperopt.github.io/hyperopt/">here</a>.</p>
<p>So, let's specify hyper-parameter ranges! We create a dictionary using the following options:</p>
<ul>
<li>
<code>hp.choice('name', list_of_values)</code>: sets a hyper-parameter to one of the values from a list. This is suitable for hyper-parameters that can have multiple distinct values like <code>boosting_type</code>
</li>
<li>
<code>hp.uniform('name', min, max)</code>: sets a hyper-parameter to a float between <code>min</code> and <code>max</code>. This works well with hyper-parameters such as <code>learning_rate</code>
</li>
<li>
<code>hp.quniform('name', min, max, step)</code>: sets a hyper-parameter to a value between <code>min</code> and <code>max</code> with a step size of <code>step</code>. This is useful for integer parameters like <code>max_depth</code>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>

<span class="c1"># training params</span>
<span class="n">lgb_reg_params</span> <span class="o">=</span> <span class="p">{</span>    
    <span class="s1">'boosting_type'</span><span class="p">:</span>    <span class="n">hp</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="s1">'boosting_type'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'gbdt'</span><span class="p">,</span> <span class="s1">'goss'</span><span class="p">]),</span>    
    <span class="s1">'objective'</span><span class="p">:</span>        <span class="s1">'rmse'</span><span class="p">,</span>
    <span class="s1">'metrics'</span><span class="p">:</span>          <span class="s1">'rmse'</span><span class="p">,</span>
    <span class="s1">'n_estimators'</span><span class="p">:</span>     <span class="mi">10000</span><span class="p">,</span>
    <span class="s1">'learning_rate'</span><span class="p">:</span>    <span class="n">hp</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">'learning_rate'</span><span class="p">,</span>  <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
    <span class="s1">'max_depth'</span><span class="p">:</span>        <span class="n">hp</span><span class="o">.</span><span class="n">quniform</span><span class="p">(</span><span class="s1">'max_depth'</span><span class="p">,</span>          <span class="mi">1</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s1">'num_leaves'</span><span class="p">:</span>       <span class="n">hp</span><span class="o">.</span><span class="n">quniform</span><span class="p">(</span><span class="s1">'num_leaves'</span><span class="p">,</span>        <span class="mi">10</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s1">'bagging_fraction'</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">'bagging_fraction'</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span>   <span class="mi">1</span><span class="p">),</span>
    <span class="s1">'feature_fraction'</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">'feature_fraction'</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span>   <span class="mi">1</span><span class="p">),</span>
    <span class="s1">'lambda_l1'</span><span class="p">:</span>        <span class="n">hp</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">'lambda_l1'</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">),</span>
    <span class="s1">'lambda_l2'</span><span class="p">:</span>        <span class="n">hp</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">'lambda_l2'</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">),</span>
    <span class="s1">'silent'</span><span class="p">:</span>           <span class="kc">True</span><span class="p">,</span>
    <span class="s1">'verbosity'</span><span class="p">:</span>        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s1">'nthread'</span> <span class="p">:</span>         <span class="mi">4</span><span class="p">,</span>
    <span class="s1">'random_state'</span><span class="p">:</span>     <span class="mi">77</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># evaluation params</span>
<span class="n">lgb_fit_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'eval_metric'</span><span class="p">:</span>           <span class="s1">'rmse'</span><span class="p">,</span>
    <span class="s1">'early_stopping_rounds'</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">'verbose'</span><span class="p">:</span>               <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># combine params</span>
<span class="n">lgb_space</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">lgb_space</span><span class="p">[</span><span class="s1">'reg_params'</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgb_reg_params</span>
<span class="n">lgb_space</span><span class="p">[</span><span class="s1">'fit_params'</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgb_fit_params</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we create <code>HPOpt</code> object that performs tuning. We can avoid this in a simple tuning task, but defining an object gives us more control of the optimization process, which is useful with a custom loss. We define three object methods:</p>
<ul>
<li>
<code>process</code>: runs optimization. By default, <code>HPO</code> uses <code>fmin()</code> to minimize the specified loss</li>
<li>
<code>lgb_reg</code>: initializes LightGBM model</li>
<li>
<code>train_reg</code>: trains LightGBM and computes the loss. Since we aim to maximize profit, we simply define loss as negative profit</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-show</span>
<span class="k">class</span> <span class="nc">HPOpt</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># INIT</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span>  <span class="o">=</span> <span class="n">x_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span>  <span class="o">=</span> <span class="n">y_test</span>

    <span class="c1"># optimization process</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">max_evals</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">fn</span>        <span class="o">=</span> <span class="n">fn</span><span class="p">,</span> 
                          <span class="n">space</span>     <span class="o">=</span> <span class="n">space</span><span class="p">,</span> 
                          <span class="n">algo</span>      <span class="o">=</span> <span class="n">algo</span><span class="p">,</span> 
                          <span class="n">max_evals</span> <span class="o">=</span> <span class="n">max_evals</span><span class="p">,</span> 
                          <span class="n">trials</span>    <span class="o">=</span> <span class="n">trials</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">'status'</span><span class="p">:</span> <span class="n">STATUS_FAIL</span><span class="p">,</span> <span class="s1">'exception'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">trials</span>
    
    
    <span class="c1"># LGBM initialization</span>
    <span class="k">def</span> <span class="nf">lgb_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
        <span class="n">para</span><span class="p">[</span><span class="s1">'reg_params'</span><span class="p">][</span><span class="s1">'max_depth'</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="s1">'reg_params'</span><span class="p">][</span><span class="s1">'max_depth'</span><span class="p">])</span>
        <span class="n">para</span><span class="p">[</span><span class="s1">'reg_params'</span><span class="p">][</span><span class="s1">'num_leaves'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="s1">'reg_params'</span><span class="p">][</span><span class="s1">'num_leaves'</span><span class="p">])</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">para</span><span class="p">[</span><span class="s1">'reg_params'</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span>

    
    <span class="c1"># training and inference</span>
    <span class="k">def</span> <span class="nf">train_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
        
        <span class="c1"># fit LGBM</span>
        <span class="n">reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                <span class="n">eval_set</span>              <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">)],</span> 
                <span class="n">sample_weight</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">eval_sample_weight</span>    <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
                <span class="o">**</span><span class="n">para</span><span class="p">[</span><span class="s1">'fit_params'</span><span class="p">])</span>
        
        <span class="c1"># inference</span>
        <span class="k">if</span> <span class="n">target_transform</span><span class="p">:</span>      
            <span class="n">preds</span> <span class="o">=</span> <span class="n">postprocess_preds</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">postprocess_preds</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">))</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span>

        <span class="c1"># compute loss [negative profit]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="o">-</span><span class="n">profit</span><span class="p">(</span><span class="n">reals</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="s1">'simulationPrice'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
                      
        <span class="k">return</span> <span class="p">{</span><span class="s1">'loss'</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s1">'status'</span><span class="p">:</span> <span class="n">STATUS_OK</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To prevent overfitting, we perform tuning on a different subset of data compared to the models trained in the previous section by going one day further in the past.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>

<span class="c1"># validation dates</span>
<span class="n">v_end</span>   <span class="o">=</span> <span class="mi">158</span>          <span class="c1"># 1 day before last validation fold in code_03_modeling</span>
<span class="n">v_start</span> <span class="o">=</span> <span class="n">v_end</span>        <span class="c1"># same as v_start</span>

<span class="c1"># training dates</span>
<span class="n">t_start</span> <span class="o">=</span> <span class="mi">28</span>           <span class="c1"># first day in the data</span>
<span class="n">t_end</span>   <span class="o">=</span> <span class="n">v_start</span> <span class="o">-</span> <span class="mi">15</span> <span class="c1"># validation day - two weeks</span>

<span class="c1"># extract index</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&gt;=</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&lt;=</span> <span class="n">t_end</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">valid_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&gt;=</span> <span class="n">v_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">&lt;=</span> <span class="n">v_end</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>   

<span class="c1"># extract samples</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">][</span><span class="n">features</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
<span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">][</span><span class="n">features</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
    
<span class="c1"># target transformation</span>
<span class="k">if</span> <span class="n">target_transform</span><span class="p">:</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)</span>

<span class="c1"># information</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'- train period days: </span><span class="si">{}</span><span class="s1"> -- </span><span class="si">{}</span><span class="s1"> (n = </span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_idx</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'- valid period days: </span><span class="si">{}</span><span class="s1"> -- </span><span class="si">{}</span><span class="s1"> (n = </span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_start</span><span class="p">,</span> <span class="n">v_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-'</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>-----------------------------------------------------------------
- train period days: 28 -- 143 (n = 1213708)
- valid period days: 158 -- 158 (n = 10463)
-----------------------------------------------------------------
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, we just need to instantiate the <code>HPOpt</code> object and launch the tuning trials! The optimization will run automatically, and we would only need to extract the optimized values:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-show</span>

<span class="c1"># instantiate objects</span>
<span class="n">hpo_obj</span> <span class="o">=</span> <span class="n">HPOpt</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
<span class="n">trials</span>  <span class="o">=</span> <span class="n">Trials</span><span class="p">()</span> 

<span class="c1"># perform tuning</span>
<span class="n">lgb_opt_params</span> <span class="o">=</span> <span class="n">hpo_obj</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">fn_name</span>   <span class="o">=</span> <span class="s1">'lgb_reg'</span><span class="p">,</span>
                                 <span class="n">space</span>     <span class="o">=</span> <span class="n">lgb_space</span><span class="p">,</span> 
                                 <span class="n">trials</span>    <span class="o">=</span> <span class="n">trials</span><span class="p">,</span> 
                                 <span class="n">algo</span>      <span class="o">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">suggest</span><span class="p">,</span> 
                                 <span class="n">max_evals</span> <span class="o">=</span> <span class="n">tuning_trials</span><span class="p">)</span>  

<span class="c1"># merge best params to fixed params</span>
<span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lgb_opt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="k">for</span> <span class="n">par_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
    <span class="n">lgb_reg_params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">par_id</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lgb_opt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">params</span><span class="p">[</span><span class="n">par_id</span><span class="p">]]</span>
    
<span class="c1"># postprocess</span>
<span class="n">lgb_reg_params</span><span class="p">[</span><span class="s1">'boosting_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">boost_types</span><span class="p">[</span><span class="n">lgb_reg_params</span><span class="p">[</span><span class="s1">'boosting_type'</span><span class="p">]]</span>
<span class="n">lgb_reg_params</span><span class="p">[</span><span class="s1">'max_depth'</span><span class="p">]</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lgb_reg_params</span><span class="p">[</span><span class="s1">'max_depth'</span><span class="p">])</span>
<span class="n">lgb_reg_params</span><span class="p">[</span><span class="s1">'num_leaves'</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lgb_reg_params</span><span class="p">[</span><span class="s1">'num_leaves'</span><span class="p">])</span>

<span class="c1"># print best params</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Best meta-parameters:'</span><span class="p">)</span>
<span class="n">lgb_reg_params</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best meta-parameters:
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'boosting_type': 'goss',
 'objective': 'rmse',
 'metrics': 'rmse',
 'n_estimators': 10000,
 'learning_rate': 0.004012,
 'max_depth': 10,
 'num_leaves': 64,
 'bagging_fraction': 0.934688,
 'feature_fraction': 0.668076,
 'lambda_l1': 0.280133,
 'lambda_l2': 0.589682,
 'silent': True,
 'verbosity': -1,
 'nthread': 4,
 'random_state': 77}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Done! Now we can save the optimized values and import them when setting up the model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>
<span class="n">par_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'../lgb_meta_params.pkl'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">lgb_reg_params</span><span class="p">,</span> <span class="n">par_file</span><span class="p">)</span>
<span class="n">par_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="6.-Closing-words">
<a class="anchor" href="#6.-Closing-words" aria-hidden="true"><span class="octicon octicon-link"></span></a>6. Closing words<a class="anchor-link" href="#6.-Closing-words"> </a>
</h1>
<p>This blog post has finally come to an end. Thank you for reading!</p>
<p>We looked at important stages of our solution and covered steps such as data aggregation, feature engineering, custom loss functions, target transformation and hyper-parameter tuning.</p>
<p>Our final solution was a simple ensemble of multiple LightGBM models with different features and training options discussed in this post. If you are interested in the ensembling part, you can find the codes in my <a href="https://github.com/kozodoi/DMC_2020">Github</a>.</p>
<p>Please feel free to use the comment window below to ask questions and stay tuned for the next editions of <a href="https://www.data-mining-cup.com">Data Mining Cup</a>!</p>

</div>
</div>
</div>
</div>



  </div><!--<div id="disqus_thread"></div>
 <script>
   var disqus_config = function () {
     this.page.url = 'https://kozodoi.me/blog/20200727/demand-forecasting';
     this.page.identifier = 'https://kozodoi.me/blog/20200727/demand-forecasting';
   };
   (function() {
     var d = document, s = d.createElement('script');
     s.src = 'https://kozodoi.disqus.com/embed.js';
     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
   })();
 </script>
 <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
--><hr style="height:1px;border-width:0;color:rgb(50,50,50);background-color:rgb(50,50,50)">

  Liked the post? Share it on social media!
  <div class="sharethis-inline-share-buttons" style = "margin-top: 3px;"></div>

  <br>

  You can also buy me a cup of tea to support my work. Thanks!
  <div class="tea">
    <a href="https://www.buymeacoffee.com/kozodoi"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me tea &emoji=&slug=kozodoi&button_colour=FFDD00&font_colour=000000&font_family=Lato&outline_colour=000000&coffee_colour=ffffff" align="left"></a>
  </div>

  <a class="u-url" href="/blog/20200727/demand-forecasting" hidden></a>

  <script src="/assets/js/mode_switcher.js"></script>

</article>

      </div>
    </main><footer class="site-footer h-card">
<data class="u-url" href="/"></data>

<div class="wrapper">

  <div class="footer-col-wrapper">

    <div class="footer-col">
      <p><center>Blog on ML, AI & other acronyms. All opinions are my own.</center></p>
    </div>

    <div class="footer-col">
      <p style="text-align:center;">&#169; 2020 - 2023 Nikita Kozodoi</p>
    </div>

  </div>

  <div class="social-links">
    <ul class="social-media-list"><li>
  <a rel="me" href="https://www.linkedin.com/in/kozodoi/" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/kozodoi" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://scholar.google.com/citations?user=58tMuD0AAAAJ&hl=en" target="_blank" title="google_scholar">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#google_scholar"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/n_kozodoi" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/n_kozodoi/" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
</ul>
  </div>

</div>

</footer>
</body>

</html>
